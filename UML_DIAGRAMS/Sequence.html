<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagramme de S√©quence - G√©n√©ration de CV</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        #diagram {
            text-align: center;
            margin: 30px 0;
            overflow-x: auto;
            background: white;
            padding: 40px;
        }
        .mermaid {
            font-size: 16px;
        }
        .buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }
        button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .download-btn {
            background-color: #4CAF50;
            color: white;
        }
        .download-btn:hover {
            background-color: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .download-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .info {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            border-left: 4px solid #2196F3;
        }
        .info p {
            margin: 5px 0;
            color: #1976D2;
        }
        #status {
            text-align: center;
            margin: 10px 0;
            color: #666;
            font-style: italic;
        }
        .legend {
            background-color: #fff3cd;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            border-left: 4px solid #ffc107;
        }
        .legend h3 {
            margin-top: 0;
            color: #856404;
        }
        .legend ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .legend li {
            margin: 5px 0;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Diagramme de S√©quence - Processus de G√©n√©ration de CV</h1>
        
        <div id="status">Chargement du diagramme...</div>
        
        <div id="diagram">
            <div class="mermaid">
sequenceDiagram
    actor User
    participant Frontend as Frontend<br/>(GenerateCV)
    participant API as API Service
    participant Controller as CV Controller
    participant Auth as Auth Middleware
    participant OpenAI as OpenAI Service
    participant Parser as CV Parser
    participant HTMLGen as HTML Generator
    participant Model as CV History<br/>(Model)
    participant DB as MongoDB

    User->>Frontend: Enter CV text and job description
    User->>Frontend: Select template
    User->>Frontend: Click "Generate CV"
    
    Frontend->>API: POST /api/cv/generate<br/>(cvText, jobDescription, template)
    
    API->>Controller: generateCV(req, res)
    
    Controller->>Auth: verifyToken(token)
    Auth-->>Controller: User authenticated
    
    Controller->>OpenAI: optimizeCV(cvText, jobDescription)
    
    activate OpenAI
    OpenAI->>OpenAI: Clean input text
    OpenAI->>OpenAI: Build optimization prompt
    OpenAI->>OpenAI: Call OpenAI API
    OpenAI-->>Controller: optimizedCVText
    deactivate OpenAI
    
    Controller->>Parser: parseCVText(optimizedCVText)
    
    activate Parser
    Parser->>Parser: extractProfile()
    Parser->>Parser: extractExperience()
    Parser->>Parser: extractEducation()
    Parser->>Parser: extractSkills()
    Parser->>Parser: extractProjects()
    Parser-->>Controller: parsedData
    deactivate Parser
    
    Controller->>HTMLGen: generateCVHTML(parsedData, template)
    
    activate HTMLGen
    HTMLGen->>HTMLGen: prepareTemplateData()
    HTMLGen->>HTMLGen: formatDescriptions()
    HTMLGen->>HTMLGen: generateHTML()
    HTMLGen-->>Controller: cvHTML
    deactivate HTMLGen
    
    Controller->>Model: new CVHistory({...})
    Controller->>Model: save()
    
    Model->>DB: Insert document
    DB-->>Model: Document saved
    Model-->>Controller: savedCV
    
    Controller-->>API: Response { success: true, data: savedCV }
    API-->>Frontend: Response with CV data
    
    Frontend->>Frontend: Display success message
    Frontend->>Frontend: Show generated CV preview
    Frontend->>Frontend: Enable download button
    
    User->>Frontend: Click "Download PDF"
    Frontend->>Frontend: Open print dialog with CV HTML
            </div>
        </div>

        <div class="buttons">
            <button class="download-btn" id="pngBtn" onclick="downloadAsPNG()" disabled>
                üì• T√©l√©charger en PNG (Haute Qualit√©)
            </button>
            <button class="download-btn" id="svgBtn" onclick="downloadAsSVG()" disabled>
                üì• T√©l√©charger en SVG (Vectoriel)
            </button>
        </div>

        <div class="legend">
            <h3>üìã √âtapes du Processus</h3>
            <ul>
                <li><strong>1. Saisie utilisateur:</strong> L'utilisateur entre le texte CV et la description du poste</li>
                <li><strong>2. Authentification:</strong> V√©rification du token d'authentification</li>
                <li><strong>3. Optimisation OpenAI:</strong> Le CV est optimis√© en fonction de la description du poste</li>
                <li><strong>4. Parsing:</strong> Extraction des diff√©rentes sections du CV (profil, exp√©rience, √©ducation, comp√©tences)</li>
                <li><strong>5. G√©n√©ration HTML:</strong> Cr√©ation du CV au format HTML selon le template choisi</li>
                <li><strong>6. Sauvegarde:</strong> Enregistrement dans MongoDB pour l'historique</li>
                <li><strong>7. R√©ponse:</strong> Affichage du CV g√©n√©r√© et activation du t√©l√©chargement PDF</li>
            </ul>
        </div>

        <div class="info">
            <p><strong>üìå Composants Principaux:</strong></p>
            <p>‚Ä¢ <strong>Frontend:</strong> Interface utilisateur React</p>
            <p>‚Ä¢ <strong>API Service:</strong> Couche de communication HTTP</p>
            <p>‚Ä¢ <strong>CV Controller:</strong> Logique m√©tier de g√©n√©ration de CV</p>
            <p>‚Ä¢ <strong>OpenAI Service:</strong> Optimisation intelligente du contenu</p>
            <p>‚Ä¢ <strong>CV Parser:</strong> Extraction et structuration des donn√©es</p>
            <p>‚Ä¢ <strong>HTML Generator:</strong> Cr√©ation du rendu visuel</p>
            <p>‚Ä¢ <strong>MongoDB:</strong> Base de donn√©es pour l'historique</p>
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose',
            sequence: {
                diagramMarginX: 50,
                diagramMarginY: 10,
                actorMargin: 100,
                width: 180,
                height: 65,
                boxMargin: 10,
                boxTextMargin: 5,
                noteMargin: 10,
                messageMargin: 35,
                mirrorActors: true,
                useMaxWidth: true
            }
        });

        setTimeout(() => {
            const svg = document.querySelector('.mermaid svg');
            if (svg) {
                document.getElementById('status').textContent = '‚úÖ Diagramme charg√© - Vous pouvez t√©l√©charger';
                document.getElementById('pngBtn').disabled = false;
                document.getElementById('svgBtn').disabled = false;
            } else {
                document.getElementById('status').textContent = '‚ö†Ô∏è Erreur de chargement - Rafra√Æchissez la page';
            }
        }, 2000);

        function downloadAsPNG() {
            const btn = document.getElementById('pngBtn');
            btn.textContent = '‚è≥ G√©n√©ration en cours...';
            btn.disabled = true;

            const diagramDiv = document.getElementById('diagram');
            
            html2canvas(diagramDiv, {
                scale: 3,
                backgroundColor: '#ffffff',
                logging: false
            }).then(canvas => {
                canvas.toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = 'diagramme-sequence-generation-cv.png';
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                    
                    btn.textContent = '‚úÖ T√©l√©charg√©!';
                    setTimeout(() => {
                        btn.textContent = 'üì• T√©l√©charger en PNG (Haute Qualit√©)';
                        btn.disabled = false;
                    }, 2000);
                });
            }).catch(err => {
                alert('Erreur: ' + err.message);
                btn.textContent = 'üì• T√©l√©charger en PNG (Haute Qualit√©)';
                btn.disabled = false;
            });
        }

        function downloadAsSVG() {
            const btn = document.getElementById('svgBtn');
            btn.textContent = '‚è≥ G√©n√©ration en cours...';
            btn.disabled = true;

            try {
                const svg = document.querySelector('.mermaid svg');
                if (!svg) {
                    alert('Erreur: SVG non trouv√©');
                    btn.disabled = false;
                    return;
                }

                const clonedSvg = svg.cloneNode(true);
                clonedSvg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
                
                const svgData = new XMLSerializer().serializeToString(clonedSvg);
                const blob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.download = 'diagramme-sequence-generation-cv.svg';
                link.href = url;
                link.click();
                URL.revokeObjectURL(url);
                
                btn.textContent = '‚úÖ T√©l√©charg√©!';
                setTimeout(() => {
                    btn.textContent = 'üì• T√©l√©charger en SVG (Vectoriel)';
                    btn.disabled = false;
                }, 2000);
            } catch (error) {
                alert('Erreur: ' + error.message);
                btn.textContent = 'üì• T√©l√©charger en SVG (Vectoriel)';
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>